17b192bdfeb7b5c6c0f09fe9ae17ec42
"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const balanceSaver_1 = __importDefault(require("@backoffice/accounts/application/save/balanceSaver"));
const saveBalanceCommandHandler_1 = __importDefault(require("@backoffice/accounts/application/save/saveBalanceCommandHandler"));
const accountRepository_mock_1 = __importDefault(require("@backoffice/accounts/__mocks__/accountRepository.mock"));
const saveBalanceCommand_mother_1 = __importDefault(require("@backoffice/accounts/__mothers__/saveBalanceCommand.mother"));
const eventBus_mock_1 = __importDefault(require("@shared/__mocks__/eventBus.mock"));
const account_mother_1 = __importDefault(require("@backoffice/accounts/__mothers__/account.mother"));
const accountId_mother_1 = __importDefault(require("@backoffice/accounts/__mothers__/accountId.mother"));
const balance_mother_1 = __importDefault(require("@backoffice/accounts/__mothers__/balance.mother"));
const accountBalanceUpdated_1 = __importDefault(require("@backoffice/accounts/domain/accountBalanceUpdated"));
describe('balanceSaver', () => {
    it('should create the balance when there isn\'t stored in our system', async () => {
        expect.hasAssertions();
        const repository = new accountRepository_mock_1.default(), bus = new eventBus_mock_1.default(), command = saveBalanceCommand_mother_1.default.random(), updater = new balanceSaver_1.default(repository, bus), handler = new saveBalanceCommandHandler_1.default(updater);
        await expect(handler.handle(command)).resolves.toBeUndefined();
        repository.assertGetIsCalled(accountId_mother_1.default.create(command.accountId));
        repository.assertSaveIsCalled();
    });
    it('should update the balance', async () => {
        expect.hasAssertions();
        const repository = new accountRepository_mock_1.default(), bus = new eventBus_mock_1.default(), command = saveBalanceCommand_mother_1.default.randomWithPositiveAmount(), account = account_mother_1.default.random(), updater = new balanceSaver_1.default(repository, bus), handler = new saveBalanceCommandHandler_1.default(updater), expected = account_mother_1.default.random({
            id: account.id,
            balance: balance_mother_1.default.create(account.balance.value + command.amount)
        });
        repository.whenGetThenReturn(account);
        await expect(handler.handle(command)).resolves.toBeUndefined();
        repository.assertGetIsCalled(accountId_mother_1.default.create(command.accountId));
        repository.assertSaveIsCalledWith(expected);
    });
    it('should publish AccountBalanceUpdatedDomainEvent', async () => {
        expect.hasAssertions();
        const repository = new accountRepository_mock_1.default(), bus = new eventBus_mock_1.default(), command = saveBalanceCommand_mother_1.default.randomWithPositiveAmount(), account = account_mother_1.default.random(), updater = new balanceSaver_1.default(repository, bus), handler = new saveBalanceCommandHandler_1.default(updater);
        repository.whenGetThenReturn(account);
        await expect(handler.handle(command)).resolves.toBeUndefined();
        repository.assertGetIsCalled(accountId_mother_1.default.create(command.accountId));
        bus.assertLastPublishedEventTypeIs(accountBalanceUpdated_1.default);
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvb3B0aXZhbWVkaWEvRG9jdW1lbnRzL1BlcnNvbmFsL2JhbmstYWNjb3VudC1tYW5hZ2VyL3NlcnZlci9jb250ZXh0cy9iYWNrb2ZmaWNlL2FjY291bnRzL2FwcGxpY2F0aW9uL3NhdmUvYmFsYW5jZVNhdmVyLnRlc3QudHMiLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSxzR0FBOEU7QUFDOUUsZ0lBQXdHO0FBQ3hHLG1IQUEwRjtBQUMxRiwySEFBa0c7QUFDbEcsb0ZBQTJEO0FBQzNELHFHQUE0RTtBQUM1RSx5R0FBZ0Y7QUFDaEYscUdBQTRFO0FBQzVFLDhHQUFpRztBQUVqRyxRQUFRLENBQUMsY0FBYyxFQUFFLEdBQUcsRUFBRTtJQUMxQixFQUFFLENBQUMsa0VBQWtFLEVBQUUsS0FBSyxJQUFJLEVBQUU7UUFDOUUsTUFBTSxDQUFDLGFBQWEsRUFBRSxDQUFDO1FBQ3ZCLE1BQU0sVUFBVSxHQUFHLElBQUksZ0NBQXFCLEVBQUUsRUFDMUMsR0FBRyxHQUFHLElBQUksdUJBQVksRUFBRSxFQUN4QixPQUFPLEdBQUcsbUNBQXdCLENBQUMsTUFBTSxFQUFFLEVBQzNDLE9BQU8sR0FBRyxJQUFJLHNCQUFZLENBQUMsVUFBVSxFQUFFLEdBQUcsQ0FBQyxFQUMzQyxPQUFPLEdBQUcsSUFBSSxtQ0FBeUIsQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUVyRCxNQUFNLE1BQU0sQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLGFBQWEsRUFBRSxDQUFDO1FBQy9ELFVBQVUsQ0FBQyxpQkFBaUIsQ0FBQywwQkFBZSxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQztRQUN4RSxVQUFVLENBQUMsa0JBQWtCLEVBQUUsQ0FBQztJQUNwQyxDQUFDLENBQUMsQ0FBQztJQUNILEVBQUUsQ0FBQywyQkFBMkIsRUFBRSxLQUFLLElBQUksRUFBRTtRQUN2QyxNQUFNLENBQUMsYUFBYSxFQUFFLENBQUM7UUFDdkIsTUFBTSxVQUFVLEdBQUcsSUFBSSxnQ0FBcUIsRUFBRSxFQUMxQyxHQUFHLEdBQUcsSUFBSSx1QkFBWSxFQUFFLEVBQ3hCLE9BQU8sR0FBRyxtQ0FBd0IsQ0FBQyx3QkFBd0IsRUFBRSxFQUM3RCxPQUFPLEdBQUcsd0JBQWEsQ0FBQyxNQUFNLEVBQUUsRUFDaEMsT0FBTyxHQUFHLElBQUksc0JBQVksQ0FBQyxVQUFVLEVBQUUsR0FBRyxDQUFDLEVBQzNDLE9BQU8sR0FBRyxJQUFJLG1DQUF5QixDQUFDLE9BQU8sQ0FBQyxFQUNoRCxRQUFRLEdBQUcsd0JBQWEsQ0FBQyxNQUFNLENBQUM7WUFDNUIsRUFBRSxFQUFFLE9BQU8sQ0FBQyxFQUFFO1lBQ2QsT0FBTyxFQUFFLHdCQUFhLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsS0FBSyxHQUFHLE9BQU8sQ0FBQyxNQUFNLENBQUM7U0FDeEUsQ0FBQyxDQUFDO1FBRVAsVUFBVSxDQUFDLGlCQUFpQixDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBRXRDLE1BQU0sTUFBTSxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxRQUFRLENBQUMsYUFBYSxFQUFFLENBQUM7UUFDL0QsVUFBVSxDQUFDLGlCQUFpQixDQUFDLDBCQUFlLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDO1FBQ3hFLFVBQVUsQ0FBQyxzQkFBc0IsQ0FBQyxRQUFRLENBQUMsQ0FBQztJQUNoRCxDQUFDLENBQUMsQ0FBQztJQUVILEVBQUUsQ0FBQyxpREFBaUQsRUFBRSxLQUFLLElBQUksRUFBRTtRQUM3RCxNQUFNLENBQUMsYUFBYSxFQUFFLENBQUM7UUFDdkIsTUFBTSxVQUFVLEdBQUcsSUFBSSxnQ0FBcUIsRUFBRSxFQUMxQyxHQUFHLEdBQUcsSUFBSSx1QkFBWSxFQUFFLEVBQ3hCLE9BQU8sR0FBRyxtQ0FBd0IsQ0FBQyx3QkFBd0IsRUFBRSxFQUM3RCxPQUFPLEdBQUcsd0JBQWEsQ0FBQyxNQUFNLEVBQUUsRUFDaEMsT0FBTyxHQUFHLElBQUksc0JBQVksQ0FBQyxVQUFVLEVBQUUsR0FBRyxDQUFDLEVBQzNDLE9BQU8sR0FBRyxJQUFJLG1DQUF5QixDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBRXJELFVBQVUsQ0FBQyxpQkFBaUIsQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUV0QyxNQUFNLE1BQU0sQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLGFBQWEsRUFBRSxDQUFDO1FBQy9ELFVBQVUsQ0FBQyxpQkFBaUIsQ0FBQywwQkFBZSxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQztRQUN4RSxHQUFHLENBQUMsOEJBQThCLENBQUMsK0JBQWdDLENBQUMsQ0FBQztJQUN6RSxDQUFDLENBQUMsQ0FBQztBQUNQLENBQUMsQ0FBQyxDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9ob21lL29wdGl2YW1lZGlhL0RvY3VtZW50cy9QZXJzb25hbC9iYW5rLWFjY291bnQtbWFuYWdlci9zZXJ2ZXIvY29udGV4dHMvYmFja29mZmljZS9hY2NvdW50cy9hcHBsaWNhdGlvbi9zYXZlL2JhbGFuY2VTYXZlci50ZXN0LnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBCYWxhbmNlU2F2ZXIgZnJvbSAnQGJhY2tvZmZpY2UvYWNjb3VudHMvYXBwbGljYXRpb24vc2F2ZS9iYWxhbmNlU2F2ZXInO1xuaW1wb3J0IFNhdmVCYWxhbmNlQ29tbWFuZEhhbmRsZXIgZnJvbSAnQGJhY2tvZmZpY2UvYWNjb3VudHMvYXBwbGljYXRpb24vc2F2ZS9zYXZlQmFsYW5jZUNvbW1hbmRIYW5kbGVyJztcbmltcG9ydCBBY2NvdW50UmVwb3NpdG9yeU1vY2sgZnJvbSAnQGJhY2tvZmZpY2UvYWNjb3VudHMvX19tb2Nrc19fL2FjY291bnRSZXBvc2l0b3J5Lm1vY2snO1xuaW1wb3J0IFNhdmVCYWxhbmNlQ29tbWFuZE1vdGhlciBmcm9tICdAYmFja29mZmljZS9hY2NvdW50cy9fX21vdGhlcnNfXy9zYXZlQmFsYW5jZUNvbW1hbmQubW90aGVyJztcbmltcG9ydCBFdmVudEJ1c01vY2sgZnJvbSAnQHNoYXJlZC9fX21vY2tzX18vZXZlbnRCdXMubW9jayc7XG5pbXBvcnQgQWNjb3VudE1vdGhlciBmcm9tICdAYmFja29mZmljZS9hY2NvdW50cy9fX21vdGhlcnNfXy9hY2NvdW50Lm1vdGhlcic7XG5pbXBvcnQgQWNjb3VudElkTW90aGVyIGZyb20gJ0BiYWNrb2ZmaWNlL2FjY291bnRzL19fbW90aGVyc19fL2FjY291bnRJZC5tb3RoZXInO1xuaW1wb3J0IEJhbGFuY2VNb3RoZXIgZnJvbSAnQGJhY2tvZmZpY2UvYWNjb3VudHMvX19tb3RoZXJzX18vYmFsYW5jZS5tb3RoZXInO1xuaW1wb3J0IEFjY291bnRCYWxhbmNlVXBkYXRlZERvbWFpbkV2ZW50IGZyb20gJ0BiYWNrb2ZmaWNlL2FjY291bnRzL2RvbWFpbi9hY2NvdW50QmFsYW5jZVVwZGF0ZWQnO1xuXG5kZXNjcmliZSgnYmFsYW5jZVNhdmVyJywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgY3JlYXRlIHRoZSBiYWxhbmNlIHdoZW4gdGhlcmUgaXNuXFwndCBzdG9yZWQgaW4gb3VyIHN5c3RlbScsIGFzeW5jICgpID0+IHtcbiAgICAgICAgZXhwZWN0Lmhhc0Fzc2VydGlvbnMoKTtcbiAgICAgICAgY29uc3QgcmVwb3NpdG9yeSA9IG5ldyBBY2NvdW50UmVwb3NpdG9yeU1vY2soKSxcbiAgICAgICAgICAgIGJ1cyA9IG5ldyBFdmVudEJ1c01vY2soKSxcbiAgICAgICAgICAgIGNvbW1hbmQgPSBTYXZlQmFsYW5jZUNvbW1hbmRNb3RoZXIucmFuZG9tKCksXG4gICAgICAgICAgICB1cGRhdGVyID0gbmV3IEJhbGFuY2VTYXZlcihyZXBvc2l0b3J5LCBidXMpLFxuICAgICAgICAgICAgaGFuZGxlciA9IG5ldyBTYXZlQmFsYW5jZUNvbW1hbmRIYW5kbGVyKHVwZGF0ZXIpO1xuXG4gICAgICAgIGF3YWl0IGV4cGVjdChoYW5kbGVyLmhhbmRsZShjb21tYW5kKSkucmVzb2x2ZXMudG9CZVVuZGVmaW5lZCgpO1xuICAgICAgICByZXBvc2l0b3J5LmFzc2VydEdldElzQ2FsbGVkKEFjY291bnRJZE1vdGhlci5jcmVhdGUoY29tbWFuZC5hY2NvdW50SWQpKTtcbiAgICAgICAgcmVwb3NpdG9yeS5hc3NlcnRTYXZlSXNDYWxsZWQoKTtcbiAgICB9KTtcbiAgICBpdCgnc2hvdWxkIHVwZGF0ZSB0aGUgYmFsYW5jZScsIGFzeW5jICgpID0+IHtcbiAgICAgICAgZXhwZWN0Lmhhc0Fzc2VydGlvbnMoKTtcbiAgICAgICAgY29uc3QgcmVwb3NpdG9yeSA9IG5ldyBBY2NvdW50UmVwb3NpdG9yeU1vY2soKSxcbiAgICAgICAgICAgIGJ1cyA9IG5ldyBFdmVudEJ1c01vY2soKSxcbiAgICAgICAgICAgIGNvbW1hbmQgPSBTYXZlQmFsYW5jZUNvbW1hbmRNb3RoZXIucmFuZG9tV2l0aFBvc2l0aXZlQW1vdW50KCksXG4gICAgICAgICAgICBhY2NvdW50ID0gQWNjb3VudE1vdGhlci5yYW5kb20oKSxcbiAgICAgICAgICAgIHVwZGF0ZXIgPSBuZXcgQmFsYW5jZVNhdmVyKHJlcG9zaXRvcnksIGJ1cyksXG4gICAgICAgICAgICBoYW5kbGVyID0gbmV3IFNhdmVCYWxhbmNlQ29tbWFuZEhhbmRsZXIodXBkYXRlciksXG4gICAgICAgICAgICBleHBlY3RlZCA9IEFjY291bnRNb3RoZXIucmFuZG9tKHtcbiAgICAgICAgICAgICAgICBpZDogYWNjb3VudC5pZCxcbiAgICAgICAgICAgICAgICBiYWxhbmNlOiBCYWxhbmNlTW90aGVyLmNyZWF0ZShhY2NvdW50LmJhbGFuY2UudmFsdWUgKyBjb21tYW5kLmFtb3VudClcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgIHJlcG9zaXRvcnkud2hlbkdldFRoZW5SZXR1cm4oYWNjb3VudCk7XG5cbiAgICAgICAgYXdhaXQgZXhwZWN0KGhhbmRsZXIuaGFuZGxlKGNvbW1hbmQpKS5yZXNvbHZlcy50b0JlVW5kZWZpbmVkKCk7XG4gICAgICAgIHJlcG9zaXRvcnkuYXNzZXJ0R2V0SXNDYWxsZWQoQWNjb3VudElkTW90aGVyLmNyZWF0ZShjb21tYW5kLmFjY291bnRJZCkpO1xuICAgICAgICByZXBvc2l0b3J5LmFzc2VydFNhdmVJc0NhbGxlZFdpdGgoZXhwZWN0ZWQpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBwdWJsaXNoIEFjY291bnRCYWxhbmNlVXBkYXRlZERvbWFpbkV2ZW50JywgYXN5bmMgKCkgPT4ge1xuICAgICAgICBleHBlY3QuaGFzQXNzZXJ0aW9ucygpO1xuICAgICAgICBjb25zdCByZXBvc2l0b3J5ID0gbmV3IEFjY291bnRSZXBvc2l0b3J5TW9jaygpLFxuICAgICAgICAgICAgYnVzID0gbmV3IEV2ZW50QnVzTW9jaygpLFxuICAgICAgICAgICAgY29tbWFuZCA9IFNhdmVCYWxhbmNlQ29tbWFuZE1vdGhlci5yYW5kb21XaXRoUG9zaXRpdmVBbW91bnQoKSxcbiAgICAgICAgICAgIGFjY291bnQgPSBBY2NvdW50TW90aGVyLnJhbmRvbSgpLFxuICAgICAgICAgICAgdXBkYXRlciA9IG5ldyBCYWxhbmNlU2F2ZXIocmVwb3NpdG9yeSwgYnVzKSxcbiAgICAgICAgICAgIGhhbmRsZXIgPSBuZXcgU2F2ZUJhbGFuY2VDb21tYW5kSGFuZGxlcih1cGRhdGVyKTtcblxuICAgICAgICByZXBvc2l0b3J5LndoZW5HZXRUaGVuUmV0dXJuKGFjY291bnQpO1xuXG4gICAgICAgIGF3YWl0IGV4cGVjdChoYW5kbGVyLmhhbmRsZShjb21tYW5kKSkucmVzb2x2ZXMudG9CZVVuZGVmaW5lZCgpO1xuICAgICAgICByZXBvc2l0b3J5LmFzc2VydEdldElzQ2FsbGVkKEFjY291bnRJZE1vdGhlci5jcmVhdGUoY29tbWFuZC5hY2NvdW50SWQpKTtcbiAgICAgICAgYnVzLmFzc2VydExhc3RQdWJsaXNoZWRFdmVudFR5cGVJcyhBY2NvdW50QmFsYW5jZVVwZGF0ZWREb21haW5FdmVudCk7XG4gICAgfSk7XG59KTtcbiJdLCJ2ZXJzaW9uIjozfQ==